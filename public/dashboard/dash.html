<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <link
      rel="shortcut icon"
      href="../assets/icon/favicon2.ico"
      type="image/x-icon"
    />
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="../assets/icon/favicon-32x32.png" />
    <title>The Witcher | Dashboard</title>

    <link rel="stylesheet" href="../css/style.css" />
    <script src="../js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="./../js/alerta.js"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />

    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!--FONT AWESOME-->
    <script
      src="https://kit.fontawesome.com/9f7414eb10.js"
      crossorigin="anonymous"
    ></script>
  </head>

  <!-- <body onload=" atualizarFeed()"> -->

  <body onload="iniciarKpiDash()" class="Dashboard">
    
    <aside>
      <div class="asiede-logo">
        <img src="../assets/imgs/Wittcher-logo.png" alt="" />
      </div>
      <nav class="nav-laterl">
        <div class="nav-container">
          <a class="nav-selecionado" href="#">Corvo Bianco</a>
          <a class="nav-desselecionado" href="">Taverna</a>
          <a href="./quiz.html">Quiz</a>
        </div>

        <div class="sair">
          <a href="">Sair</a>
        </div>
      </nav>
    </aside>

    <video autoplay muted loop id="myVideo">
      <source src="../assets/videos/menu-tw3.mp4" type="video/mp4" />
      Your browser does not support HTML5 video.
    </video>

    <div class="Dashboard-features">
      <section class="section-title">
        <h1>Bem Vindo <span id="nomeTitulo"></span> a Corvo Bianco</h1>
      </section>

      <section class="section-stats">
        <div class="box-class">
          <h2 style="color: rgb(218, 218, 218);" class="title-box">Sua Classe</h2>
          <p class="title-box" >Bruxo</p>
          <div class="background">
            <img id="imgClasseUsuario" alt="" />
          </div>
        </div>

        <div class="box-stats">
          <p class="title-stats">Estatísticas</p>
          <div id="bg-vitalidade" class="conteiner-stats">
            <img class="icon-dash" src="../assets/imgs/vitalidade.png" alt="" />
            <div  class="text-container">
              <p>Vitalidade</p>
              <div class="kpiResultado" id="kpiVitalidade"></div>
            </div>
          </div>
          <div id="bg-combate" class="conteiner-stats">
            <img class="icon-dash" src="../assets/imgs/combate.png" alt="" />
            <div class="text-container">
              <p>Combate</p>
              <div class="kpiResultado" id="kpiCombate"></div>
            </div>
          </div>
          <div id="bg-influencia" class="conteiner-stats">
            <img class="icon-dash" src="../assets/imgs/influencia.png" alt="" />
            <div class="text-container">
              <p>Influência</p>
              <div class="kpiResultado" id="kpiInfluencia"></div>
            </div>
          </div>
          <div id="bg-conhecimento" class="conteiner-stats">
            <img class="icon-dash" src="../assets/imgs/conhecimento.png" alt="" />
            <div class="text-container">
              <p>Conhecimento</p>
              <div class="kpiResultado" id="kpiConhecimento"></div>
            </div>
          </div>
          <div id="bg-discricao" class="conteiner-stats">
            <img class="icon-dash" src="../assets/imgs/discricao.png" alt="" />
            <div class="text-container">
              <p>Discrição</p>
              <div class="kpiResultado" id="kpiDiscricao"></div>
            </div>
          </div>
        </div>

        <div class="box-stats">
          <p class="title-stats">Contratos</p>
          <div id="bg-vitalidade" class="container-contracts">
            <img class="icon-dash" src="../assets/imgs/garra.png" alt="" />
            <div class="text-container">
              <p>Monstros Abatidos</p>
              <p>2000</p>
            </div>
          </div>
          <div id="bg-provas" class="container-contracts">
            <img class="icon-dash" src="../assets/imgs/provas.png" alt="" />
            <div class="text-container">
              <p>Provas Superadas</p>
              <p>2000</p>
            </div>
          </div>
        </div>

        <div class="info-graph">
          <div>
            <canvas id="quiz-graph"></canvas>
          </div>
        </div>
      </section>

      <section class="section-info">
        <div class="info-class">
          <div class="title-class">
            <p class="title-stats">Sobre</p>
          </div>
          <div class="text-class">
            <div id="sobreClasse"></div>
          </div>
        </div>

        <div class="info-graph">
          <div>
            <canvas id="myChart"></canvas>
          </div>
        </div>
      </section>
    </div>
  </body>
</html>

<script>
  // CHART JS

  const kpiVitalidade = document.getElementById("kpiVitalidade");
  const kpiCombate = document.getElementById("kpiCombate");
  const kpiInfluencia = document.getElementById("kpiInfluencia");
  const kpiConhecimento = document.getElementById("kpiConhecimento");
  const kpiDiscricao = document.getElementById("kpiDiscricao");
  const imgClasseUsuario = document.getElementById("imgClasseUsuario");
  const sobreClasse = document.getElementById("sobreClasse");
  const nomeTitulo = document.getElementById("nomeTitulo");

  //  b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

  let proximaAtualizacao;

  // window.onload = exibirAquariosDoUsuario;

  function iniciarKpiDash() {
    let proximaAtualizacao; // Mantém a variável de timing

    const idUsuarioLogado = sessionStorage.ID_USUARIO;

    fetch("/dash/nomeTitulo", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        idUsuarioServer: idUsuarioLogado,
      }),
    })
      .then(function (resposta) {
        console.log("ESTOU NO THEN DO fetch nomeTitulo!");

        if (resposta.ok) {
          resposta.json().then((json) => {
            if (json && json.length > 0 && json[0].nomeUsuario != undefined) {
              nomeTitulo.innerHTML = json[0].nomeUsuario;
            } else {
              nomeTitulo.innerHTML = "0";
            }
          });
        } else {
          resposta
            .text()
            .then((text) => console.error("Detalhes do Erro no Server:", text));
          nomeTitulo.innerHTML = "Erro Server";
        }
      })
      .catch(function (erro) {
        console.error("Erro no fetch da KPI:", erro);
        nomeTitulo.innerHTML = "Falha";
      });

    // Leitura mais segura do ID, DENTRO da função onload

    fetch("/dash/imgClasseUsuario", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        idUsuarioServer: idUsuarioLogado,
      }),
    })
      .then(function (resposta) {
        console.log("ESTOU NO THEN DO fetch imgClasseUsuario!");

        if (resposta.ok) {
          resposta.json().then((json) => {
            if (json && json.length > 0 && json[0].urlClasse != undefined) {
              imgClasseUsuario.src = json[0].urlClasse;
            } else {
              imgClasseUsuario.innerHTML = "URL DA IMAGEM nÂO encontrada";
            }
          });
        } else {
          resposta
            .text()
            .then((text) => console.error("Detalhes do Erro no Server:", text));
          imgClasseUsuario.innerHTML = "Erro Server ao procurar img";
        }
      })
      .catch(function (erro) {
        console.error("Erro no fetch da KPI:", erro);
        imgClasseUsuario.innerHTML = "Falha";
      });

    // FETCH DAs KPIs
    fetch("/dash/kpiVitalidade", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        idUsuarioServer: idUsuarioLogado,
      }),
    })
      .then(function (resposta) {
        console.log("ESTOU NO THEN DO fetch kpiVitalidade!");

        if (resposta.ok) {
          resposta.json().then((json) => {
            if (json && json.length > 0 && json[0].vitalidade != undefined) {
              kpiVitalidade.innerHTML = json[0].vitalidade;
            } else {
              kpiVitalidade.innerHTML = "0";
            }
          });
        } else {
          resposta
            .text()
            .then((text) => console.error("Detalhes do Erro no Server:", text));
          kpiVitalidade.innerHTML = "Erro Server";
        }
      })
      .catch(function (erro) {
        console.error("Erro no fetch da KPI:", erro);
        kpiVitalidade.innerHTML = "Falha";
      });

    fetch("/dash/kpiCombate", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        idUsuarioServer: idUsuarioLogado,
      }),
    })
      .then(function (resposta) {
        console.log("ESTOU NO THEN DO fetch kpiCombate!");

        if (resposta.ok) {
          resposta.json().then((json) => {
            if (json && json.length > 0 && json[0].combateClasse != undefined) {
              kpiCombate.innerHTML = json[0].combateClasse;
            } else {
              kpiCombate.innerHTML = "0";
            }
          });
        } else {
          resposta
            .text()
            .then((text) => console.error("Detalhes do Erro no Server:", text));
          kpiCombate.innerHTML = "Erro Server";
        }
      })
      .catch(function (erro) {
        console.error("Erro no fetch da KPI:", erro);
        kpiCombate.innerHTML = "Falha";
      });

    fetch("/dash/kpiInfluencia", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        idUsuarioServer: idUsuarioLogado,
      }),
    })
      .then(function (resposta) {
        console.log("ESTOU NO THEN DO fetch kpiInfluencia!");

        if (resposta.ok) {
          resposta.json().then((json) => {
            if (
              json &&
              json.length > 0 &&
              json[0].influenciaClasse != undefined
            ) {
              kpiInfluencia.innerHTML = json[0].influenciaClasse;
            } else {
              kpiInfluencia.innerHTML = "0";
            }
          });
        } else {
          resposta
            .text()
            .then((text) => console.error("Detalhes do Erro no Server:", text));
          kpiInfluencia.innerHTML = "Erro Server";
        }
      })
      .catch(function (erro) {
        console.error("Erro no fetch da KPI:", erro);
        kpiInfluencia.innerHTML = "Falha";
      });

    fetch("/dash/kpiConhecimento", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        idUsuarioServer: idUsuarioLogado,
      }),
    })
      .then(function (resposta) {
        console.log("ESTOU NO THEN DO fetch kpiConhecimento!");

        if (resposta.ok) {
          resposta.json().then((json) => {
            if (
              json &&
              json.length > 0 &&
              json[0].conhecimentoClasse != undefined
            ) {
              kpiConhecimento.innerHTML = json[0].conhecimentoClasse;
            } else {
              kpiConhecimento.innerHTML = "0";
            }
          });
        } else {
          resposta
            .text()
            .then((text) => console.error("Detalhes do Erro no Server:", text));
          kpiConhecimento.innerHTML = "Erro Server";
        }
      })
      .catch(function (erro) {
        console.error("Erro no fetch da KPI:", erro);
        kpiConhecimento.innerHTML = "Falha";
      });

    fetch("/dash/kpiDiscricao", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        idUsuarioServer: idUsuarioLogado,
      }),
    })
      .then(function (resposta) {
        console.log("ESTOU NO THEN DO fetch kpiDiscricao!");

        if (resposta.ok) {
          resposta.json().then((json) => {
            if (
              json &&
              json.length > 0 &&
              json[0].discricaoClasse != undefined
            ) {
              kpiDiscricao.innerHTML = json[0].discricaoClasse;
            } else {
              kpiDiscricao.innerHTML = "0";
            }
          });
        } else {
          resposta
            .text()
            .then((text) => console.error("Detalhes do Erro no Server:", text));
          kpiDiscricao.innerHTML = "Erro Server";
        }
      })
      .catch(function (erro) {
        console.error("Erro no fetch da KPI:", erro);
        kpiDiscricao.innerHTML = "Falha";
      });

    fetch("/dash/sobreClasse", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        idUsuarioServer: idUsuarioLogado,
      }),
    })
      .then(function (resposta) {
        console.log("ESTOU NO THEN DO fetch sobreClasse!");

        if (resposta.ok) {
          resposta.json().then((json) => {
            if (
              json &&
              json.length > 0 &&
              json[0].descricaoClasse != undefined
            ) {
              sobreClasse.innerHTML = json[0].descricaoClasse;
            } else {
              sobreClasse.innerHTML = "0";
            }
          });
        } else {
          resposta
            .text()
            .then((text) => console.error("Detalhes do Erro no Server:", text));
          sobreClasse.innerHTML = "Erro Server";
        }
      })
      .catch(function (erro) {
        console.error("Erro no fetch da KPI:", erro);
        sobreClasse.innerHTML = "Falha";
      });

    obterDadosGrafico(idUsuarioLogado);
  }

  //   

  // O gráfico é construído com três funções:
  // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
  // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
  // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

  // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
  // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
  // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

  //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
  //     Para ajustar o "select", ajuste o comando sql em src/models
  function obterDadosGrafico(idUsuarioLogado) {
    // alterarTitulo(idUsuarioLogado);

    //Verificação pra saber se a chamadad do grafico esta entrando na função


    // if (proximaAtualizacao != undefined) {
    //   clearTimeout(proximaAtualizacao);
    // }

    fetch(`/graph/grafico1/${idUsuarioLogado}`, { cache: "no-store" })

      .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
            resposta.reverse();

            plotarGrafico(resposta, idUsuarioLogado);
          });
        } else {
          console.error("Nenhum dado encontrado ou erro na API");
        }
      })
      .catch(function (error) {
        console.error(
          `Erro na obtenção dos dados p/ gráfico: ${error.message}`
        );
      });
  }

  // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
  // Configura o gráfico (cores, tipo, etc), materializa-o na página e,
  // A função *plotarGrafico* também invoca a função *atualizarGrafico*
  function plotarGrafico(resposta, idUsuarioLogado) {
    console.log("iniciando plotagem do gráfico...");

    // Criando estrutura para plotar gráfico - labels
    //GRAFICO DOS QUIZ

    //     const ctq = document.getElementById("quiz-graph");
    // new Chart(ctq, {
    //     type: "bar",
    //     data: {
    //       labels: [""],
    //       datasets: [
    //         {
    //           label: "Quiz 1",
    //           data: [],
    //           borderWidth: 1,
    //           backgroundColor: "#DE1414",
    //           borderColor: "#DE1414",
    //           borderRadius: 50,
    //         },
    //         {
    //           label: "Quiz 2",
    //           data: [],
    //           borderWidth: 0,
    //           backgroundColor: "#60088F",
    //           borderColor: "#60088F",
    //           borderRadius: 50,
    //         },
    //         {
    //           label: "Quiz 3",
    //           data: [],
    //           borderWidth: 0,
    //           backgroundColor: "#2A862E",
    //           borderColor: "#2A862E",
    //           borderRadius: 50,

    //         }
    //       ],
    //     },
    //     options: {
    //       layout: {
    //         padding: {
    //           bottom: 9
    //         }
    //       },
    //       plugins:{
    //         legend:{
    //           position: 'bottom',
    //           labels:{
    //             usePointStyle: true,
    //             pointStyle: 'circle',
    //             font: {
    //               size: 12
    //             },
    //             color: '#fff',
    //           }
    //         }
    //       },
    //       responsive: true,
    //       maintainAspectRatio: false,
    //       scales: {
    //         y: {
    //           min: 0,
    //           max: 20,
    //           ticks: {
    //             font: {
    //               size: 12,
    //             },
    //             color: '#fff',
    //           },
    //           grid:{
    //             color: '#ffffff50'
    //           }
    //         },

    //         x: {
    //           ticks: {
    //             font: {
    //               size: 7,
    //             },
    //           },
    //         },
    //       },
    //     },
    //   });

    if (!resposta || resposta.length === 0) {
      console.warn("Nenhum dado de quiz encontrado para plotar.");
      // Pode desenhar um gráfico vazio ou esconder o canvas
      return;
    }

    const ultimoResultado = resposta[0]; // Pega o resultado mais recente (devido ao LIMIT 1)

    // Colunas retornadas: acertos, perguntas, pontuacao
    const totalAcertos = ultimoResultado.acertos;
    const totalQuestoes = ultimoResultado.perguntas;
    const totalErros = totalQuestoes - totalAcertos;

    //GRAFICO DAS CLASSES

    let labels = ["Acertos", "Erros"];
    let dados = {
      labels: labels,
      datasets: [
        {
          data: [totalAcertos, totalErros],
          borderWidth: 0,
          backgroundColor: ["#60088F", "#0A0A0A"], 
        },
      ],
    };

    const options = {
      plugins: {
        legend: {
          position: "bottom",
          labels: {
            usePointStyle: true,
            pointStyle: "circle",
            font: { size: 11, color: "#fff" },
          },
        },
        title: {
          display: true,
          text: `Acertos nos Quizes (Total de ${totalQuestoes} Questões)`,
          color: "#fff",
        },
      },
      responsive: true,
      maintainAspectRatio: false,
    };

    const config = {
      type: "pie", // Tipo PIZZA
      data: dados,
      options: options,
    };

    // Altere a div do gráfico de pizza se ela for 'myChart' ou 'quiz-graph'
    let ctx = new Chart(document.getElementById("quiz-graph"), config);


    // Se o gráfico do quiz for estático, você não precisa de setTimeout e atualizarGrafico
  }

  // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
  // buscando a última medida inserida em tabela contendo as capturas,

  //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
  //     Para ajustar o "select", ajuste o comando sql em src/models
</script>
